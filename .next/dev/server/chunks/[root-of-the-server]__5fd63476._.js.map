{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"sources":["file:///D:/erp_project/src/app/lib/db.js"],"sourcesContent":["import mysql from 'mysql2/promise';\r\n\r\nconst dbConfig = {\r\n  host: process.env.DB_HOST,\r\n  user: process.env.DB_USER,\r\n  password: process.env.DB_PASSWORD,\r\n  database: process.env.DB_NAME,\r\n  port: process.env.DB_PORT,\r\n  waitForConnections: true,\r\n  connectionLimit: 30, // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô connection ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÉ‡∏ô pool\r\n  queueLimit: 0,\r\n  enableKeepAlive: true,\r\n  keepAliveInitialDelay: 10000,\r\n\r\n\r\n};\r\n\r\n// --- ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ Singleton ---\r\n// ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ pool ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á? ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏¥‡∏°\r\n// ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≥‡∏ï‡∏≠‡∏ô Hot Reload)\r\nlet pool;\r\n\r\n// üî• ‡∏ó‡∏µ‡πÄ‡∏î‡πá‡∏î 2: Singleton Pattern\r\n// ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤ \"‡πÄ‡∏Ñ‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏ß‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á?\"\r\nif (process.env.NODE_ENV === 'production') {\r\n  // ‡∏ñ‡πâ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏à‡∏£‡∏¥‡∏á ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥\r\n  pool = mysql.createPool(dbConfig);\r\n} else {\r\n  // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏£‡∏≤ (Dev) ‡πÉ‡∏´‡πâ‡∏ù‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà Global\r\n  // ‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡πÅ‡∏•‡πâ‡∏ß Save ‡πÉ‡∏´‡∏°‡πà Next.js ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î ‡∏Å‡πá‡∏à‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏ó‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏° ‡πÑ‡∏°‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏ã‡πâ‡∏≠‡∏ô‡∏ó‡∏±‡∏ö‡∏Å‡∏±‡∏ô\r\n  if (!global.mysqlPool) {\r\n    global.mysqlPool = mysql.createPool(dbConfig);\r\n  }\r\n  pool = global.mysqlPool;\r\n}\r\n\r\nexport default pool;"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,WAAW;IACf,MAAM,QAAQ,GAAG,CAAC,OAAO;IACzB,MAAM,QAAQ,GAAG,CAAC,OAAO;IACzB,UAAU,QAAQ,GAAG,CAAC,WAAW;IACjC,UAAU,QAAQ,GAAG,CAAC,OAAO;IAC7B,MAAM,QAAQ,GAAG,CAAC,OAAO;IACzB,oBAAoB;IACpB,iBAAiB;IACjB,YAAY;IACZ,iBAAiB;IACjB,uBAAuB;AAGzB;AAEA,2BAA2B;AAC3B,qEAAqE;AACrE,2DAA2D;AAC3D,IAAI;AAEJ,iCAAiC;AACjC,gDAAgD;AAChD;;KAGO;IACL,oDAAoD;IACpD,4FAA4F;IAC5F,IAAI,CAAC,yDAAO,SAAS,EAAE;QACrB,yDAAO,SAAS,GAAG,8IAAK,CAAC,UAAU,CAAC;IACtC;IACA,OAAO,yDAAO,SAAS;AACzB;uCAEe"}},
    {"offset": {"line": 157, "column": 0}, "map": {"version":3,"sources":["file:///D:/erp_project/src/app/api/notifications/route.js"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport { jwtVerify } from 'jose';\r\nimport pool from '../../lib/db';\r\n\r\n// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤ (Auto-Check)\r\nasync function checkProductionDeadlines(connection) {\r\n    try {\r\n        const today = new Date().toISOString().split('T')[0];\r\n        \r\n        // ‡∏´‡∏≤‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à\r\n        const [projects] = await connection.query(`\r\n            SELECT p.* FROM projects p \r\n            WHERE p.status NOT IN ('completed', 'canceled') \r\n            AND p.due_date IS NOT NULL\r\n        `);\r\n\r\n        for (const project of projects) {\r\n            const dueDate = new Date(project.due_date);\r\n            const now = new Date();\r\n            const diffTime = dueDate - now;\r\n            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));\r\n\r\n            let notifType = null;\r\n            let title = '';\r\n            let message = '';\r\n\r\n            if (diffDays < 0) {\r\n                notifType = 'danger';\r\n                title = `‚ö†Ô∏è ‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤: ${project.project_name}`;\r\n                message = `‡πÄ‡∏•‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á ${Math.abs(diffDays)} ‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß!`;\r\n            } else if (diffDays >= 0 && diffDays <= 3) {\r\n                notifType = 'warning';\r\n                title = `‚è≥ ‡πÉ‡∏Å‡∏•‡πâ‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î: ${project.project_name}`;\r\n                message = `‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏µ‡∏Å ${diffDays} ‡∏ß‡∏±‡∏ô`;\r\n            }\r\n\r\n            if (notifType) {\r\n                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÑ‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á\r\n                const [existing] = await connection.query(`\r\n                    SELECT id FROM notifications \r\n                    WHERE title = ? AND DATE(created_at) = ?\r\n                `, [title, today]);\r\n\r\n                if (existing.length === 0) {\r\n                    // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏ä‡πâ emp_code ‡πÅ‡∏ó‡∏ô user_id\r\n                    // ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ 'SYSTEM' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á\r\n                    await connection.query(`\r\n                        INSERT INTO notifications (emp_code, title, message, type, link)\r\n                        VALUES ('SYSTEM', ?, ?, ?, ?)\r\n                    `, [title, message, notifType, `/production/project/${project.id}`]);\r\n                }\r\n            }\r\n        }\r\n    } catch (err) {\r\n        console.error(\"Auto Check Error:\", err);\r\n    }\r\n}\r\n\r\nexport async function GET(request) {\r\n  let connection;\r\n  try {\r\n    // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Token\r\n    const token = request.cookies.get('token')?.value;\r\n    if (!token) return NextResponse.json([], { status: 401 });\r\n\r\n    const secret = new TextEncoder().encode(process.env.JWT_SECRET);\r\n    const { payload } = await jwtVerify(token, secret);\r\n    \r\n    // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏î‡∏∂‡∏á emp_code ‡∏à‡∏≤‡∏Å Token\r\n    const empCode = payload.emp_code; \r\n\r\n    connection = await pool.getConnection();\r\n\r\n    // 2. ‡∏™‡∏±‡πà‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥\r\n    await checkProductionDeadlines(connection);\r\n\r\n    // 3. ‡∏î‡∏∂‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô\r\n    // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: SELECT ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ emp_code ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏ô‡∏ô‡∏±‡πâ‡∏ô OR ‡∏Ç‡∏≠‡∏á 'SYSTEM'\r\n    const [rows] = await connection.query(\r\n        `SELECT * FROM notifications \r\n         WHERE emp_code = ? OR emp_code = 'SYSTEM' \r\n         ORDER BY is_read ASC, created_at DESC \r\n         LIMIT 20`,\r\n        [empCode] \r\n    );\r\n\r\n    const unreadCount = rows.filter(n => !n.is_read).length;\r\n\r\n    return NextResponse.json({ notifications: rows, unreadCount });\r\n\r\n  } catch (error) {\r\n    console.error(\"GET Notif Error:\", error);\r\n    return NextResponse.json({ error: error.message }, { status: 500 });\r\n  } finally {\r\n    if (connection) connection.release();\r\n  }\r\n}\r\n\r\nexport async function PUT(request) {\r\n    try {\r\n        const body = await request.json();\r\n        const { id } = body;\r\n        \r\n        if (id) {\r\n            await pool.query('UPDATE notifications SET is_read = TRUE WHERE id = ?', [id]);\r\n        }\r\n        return NextResponse.json({ success: true });\r\n    } catch (error) {\r\n        return NextResponse.json({ error: error.message }, { status: 500 });\r\n    }\r\n}"],"names":[],"mappings":"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"}}]
}