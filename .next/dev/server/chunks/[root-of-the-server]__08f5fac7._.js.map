{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/erp_project/src/app/api/accounting/invoices/%5Bid%5D/route.js"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport pool from '@/lib/db';\r\n\r\n// PUT: อัปเดตสถานะ -> สร้างใบเสร็จ\r\nexport async function PUT(request, { params }) {\r\n    // ⚠️ แก้ไขจุดสำคัญ: ใส่ await params สำหรับ Next.js 15+\r\n    const { id } = await params; \r\n    \r\n    const body = await request.json(); // รับค่า { status: 'paid' }\r\n\r\n    console.log(\"Updating Invoice ID:\", id, \"Status:\", body.status); // เช็ค Log ใน Terminal\r\n\r\n    if (body.status === 'paid') {\r\n        const connection = await pool.getConnection();\r\n        try {\r\n            await connection.beginTransaction();\r\n\r\n            // 1. ✅ อัปเดตสถานะในตาราง invoices\r\n            const [updateResult] = await connection.execute(\r\n                'UPDATE invoices SET status = ? WHERE id = ?',\r\n                ['paid', id]\r\n            );\r\n\r\n            // เช็คว่าอัปเดตเจอไหม\r\n            if (updateResult.affectedRows === 0) {\r\n                throw new Error(`Invoice ID ${id} not found`);\r\n            }\r\n\r\n            // 2. ✅ ดึงข้อมูล Invoice ใบนั้นออกมา\r\n            const [rows] = await connection.execute('SELECT * FROM invoices WHERE id = ?', [id]);\r\n            const invoice = rows[0];\r\n\r\n            if (invoice) {\r\n                // สร้างเลขที่ใบเสร็จ (เปลี่ยน INV เป็น RC)\r\n                const newDocNumber = invoice.doc_number.replace('INV', 'RC');\r\n                \r\n                // 3. ✅ สร้างใบเสร็จลงตาราง receipts\r\n                await connection.execute(\r\n                    `INSERT INTO receipts \r\n                    (invoice_id, doc_number, doc_date, amount, payment_method, created_at) \r\n                    VALUES (?, ?, NOW(), ?, 'Transfer', NOW())`,\r\n                    [invoice.id, newDocNumber, invoice.grand_total]\r\n                );\r\n                console.log(\"Receipt created for Invoice:\", invoice.doc_number);\r\n            }\r\n\r\n            await connection.commit();\r\n            return NextResponse.json({ success: true, message: \"บันทึกการชำระเงินเรียบร้อย\" });\r\n\r\n        } catch (error) {\r\n            await connection.rollback();\r\n            console.error(\"Database Error:\", error); // ดู Error ใน Terminal ถ้ามีปัญหา\r\n            return NextResponse.json({ error: error.message }, { status: 500 });\r\n        } finally {\r\n            connection.release();\r\n        }\r\n    }\r\n\r\n    // กรณีสถานะอื่น (เช่น Cancelled)\r\n    if (body.status === 'cancelled') {\r\n        const connection = await pool.getConnection();\r\n        try {\r\n            await connection.execute('UPDATE invoices SET status = ? WHERE id = ?', ['cancelled', id]);\r\n            return NextResponse.json({ success: true, message: \"ยกเลิกเอกสารเรียบร้อย\" });\r\n        } catch (error) {\r\n            return NextResponse.json({ error: error.message }, { status: 500 });\r\n        } finally {\r\n            connection.release();\r\n        }\r\n    }\r\n\r\n    return NextResponse.json({ error: \"Invalid Action\" }, { status: 400 });\r\n}\r\n\r\n// GET: ดึงข้อมูล (สำหรับหน้าดูรายละเอียด)\r\nexport async function GET(request, { params }) {\r\n    // ⚠️ แก้ไขจุดสำคัญ: ใส่ await params เช่นกัน\r\n    const { id } = await params;\r\n\r\n    try {\r\n        const [rows] = await pool.query('SELECT * FROM invoices WHERE id = ?', [id]);\r\n        if (rows.length === 0) return NextResponse.json({ error: \"Not found\" }, { status: 404 });\r\n        \r\n        // จำลองรายการสินค้า\r\n        const items = [\r\n            { description: 'ค่าบริการ (Service)', quantity: 1, unit_price: rows[0].grand_total, total: rows[0].grand_total }\r\n        ];\r\n\r\n        return NextResponse.json({ invoice: rows[0], items });\r\n    } catch (error) {\r\n        console.error(\"GET Error:\", error);\r\n        return NextResponse.json({ error: \"Failed\" }, { status: 500 });\r\n    }\r\n}"],"names":[],"mappings":";;;;;;AAAA;;;;;;;;AAIO,eAAe,IAAI,OAAO,EAAE,EAAE,MAAM,EAAE;IACzC,wDAAwD;IACxD,MAAM,EAAE,EAAE,EAAE,GAAG,MAAM;IAErB,MAAM,OAAO,MAAM,QAAQ,IAAI,IAAI,4BAA4B;IAE/D,QAAQ,GAAG,CAAC,wBAAwB,IAAI,WAAW,KAAK,MAAM,GAAG,uBAAuB;IAExF,IAAI,KAAK,MAAM,KAAK,QAAQ;QACxB,MAAM,aAAa,MAAM,KAAK,aAAa;QAC3C,IAAI;YACA,MAAM,WAAW,gBAAgB;YAEjC,mCAAmC;YACnC,MAAM,CAAC,aAAa,GAAG,MAAM,WAAW,OAAO,CAC3C,+CACA;gBAAC;gBAAQ;aAAG;YAGhB,sBAAsB;YACtB,IAAI,aAAa,YAAY,KAAK,GAAG;gBACjC,MAAM,IAAI,MAAM,CAAC,WAAW,EAAE,GAAG,UAAU,CAAC;YAChD;YAEA,qCAAqC;YACrC,MAAM,CAAC,KAAK,GAAG,MAAM,WAAW,OAAO,CAAC,uCAAuC;gBAAC;aAAG;YACnF,MAAM,UAAU,IAAI,CAAC,EAAE;YAEvB,IAAI,SAAS;gBACT,2CAA2C;gBAC3C,MAAM,eAAe,QAAQ,UAAU,CAAC,OAAO,CAAC,OAAO;gBAEvD,oCAAoC;gBACpC,MAAM,WAAW,OAAO,CACpB,CAAC;;8DAEyC,CAAC,EAC3C;oBAAC,QAAQ,EAAE;oBAAE;oBAAc,QAAQ,WAAW;iBAAC;gBAEnD,QAAQ,GAAG,CAAC,gCAAgC,QAAQ,UAAU;YAClE;YAEA,MAAM,WAAW,MAAM;YACvB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,SAAS;gBAAM,SAAS;YAA6B;QAEpF,EAAE,OAAO,OAAO;YACZ,MAAM,WAAW,QAAQ;YACzB,QAAQ,KAAK,CAAC,mBAAmB,QAAQ,kCAAkC;YAC3E,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO,MAAM,OAAO;YAAC,GAAG;gBAAE,QAAQ;YAAI;QACrE,SAAU;YACN,WAAW,OAAO;QACtB;IACJ;IAEA,iCAAiC;IACjC,IAAI,KAAK,MAAM,KAAK,aAAa;QAC7B,MAAM,aAAa,MAAM,KAAK,aAAa;QAC3C,IAAI;YACA,MAAM,WAAW,OAAO,CAAC,+CAA+C;gBAAC;gBAAa;aAAG;YACzF,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,SAAS;gBAAM,SAAS;YAAwB;QAC/E,EAAE,OAAO,OAAO;YACZ,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO,MAAM,OAAO;YAAC,GAAG;gBAAE,QAAQ;YAAI;QACrE,SAAU;YACN,WAAW,OAAO;QACtB;IACJ;IAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;QAAE,OAAO;IAAiB,GAAG;QAAE,QAAQ;IAAI;AACxE;AAGO,eAAe,IAAI,OAAO,EAAE,EAAE,MAAM,EAAE;IACzC,6CAA6C;IAC7C,MAAM,EAAE,EAAE,EAAE,GAAG,MAAM;IAErB,IAAI;QACA,MAAM,CAAC,KAAK,GAAG,MAAM,KAAK,KAAK,CAAC,uCAAuC;YAAC;SAAG;QAC3E,IAAI,KAAK,MAAM,KAAK,GAAG,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAY,GAAG;YAAE,QAAQ;QAAI;QAEtF,oBAAoB;QACpB,MAAM,QAAQ;YACV;gBAAE,aAAa;gBAAuB,UAAU;gBAAG,YAAY,IAAI,CAAC,EAAE,CAAC,WAAW;gBAAE,OAAO,IAAI,CAAC,EAAE,CAAC,WAAW;YAAC;SAClH;QAED,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS,IAAI,CAAC,EAAE;YAAE;QAAM;IACvD,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,cAAc;QAC5B,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAS,GAAG;YAAE,QAAQ;QAAI;IAChE;AACJ"}}]
}