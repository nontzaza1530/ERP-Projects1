{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"sources":["file:///D:/erp_project/src/app/lib/db.js"],"sourcesContent":["import mysql from 'mysql2/promise';\r\n\r\nconst dbConfig = {\r\n  host: process.env.DB_HOST,\r\n  user: process.env.DB_USER,\r\n  password: process.env.DB_PASSWORD,\r\n  database: process.env.DB_NAME,\r\n  port: process.env.DB_PORT,\r\n  waitForConnections: true,\r\n  connectionLimit: 30, // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô connection ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÉ‡∏ô pool\r\n  queueLimit: 0,\r\n  enableKeepAlive: true,\r\n  keepAliveInitialDelay: 10000,\r\n\r\n\r\n};\r\n\r\n// --- ‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ Singleton ---\r\n// ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ pool ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á? ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏¥‡∏°\r\n// ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≥‡∏ï‡∏≠‡∏ô Hot Reload)\r\nlet pool;\r\n\r\n// üî• ‡∏ó‡∏µ‡πÄ‡∏î‡πá‡∏î 2: Singleton Pattern\r\n// ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤ \"‡πÄ‡∏Ñ‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏ß‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á?\"\r\nif (process.env.NODE_ENV === 'production') {\r\n  // ‡∏ñ‡πâ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏à‡∏£‡∏¥‡∏á ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥\r\n  pool = mysql.createPool(dbConfig);\r\n} else {\r\n  // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏£‡∏≤ (Dev) ‡πÉ‡∏´‡πâ‡∏ù‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà Global\r\n  // ‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡πÅ‡∏•‡πâ‡∏ß Save ‡πÉ‡∏´‡∏°‡πà Next.js ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î ‡∏Å‡πá‡∏à‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏ó‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏° ‡πÑ‡∏°‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏ã‡πâ‡∏≠‡∏ô‡∏ó‡∏±‡∏ö‡∏Å‡∏±‡∏ô\r\n  if (!global.mysqlPool) {\r\n    global.mysqlPool = mysql.createPool(dbConfig);\r\n  }\r\n  pool = global.mysqlPool;\r\n}\r\n\r\nexport default pool;"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,WAAW;IACf,MAAM,QAAQ,GAAG,CAAC,OAAO;IACzB,MAAM,QAAQ,GAAG,CAAC,OAAO;IACzB,UAAU,QAAQ,GAAG,CAAC,WAAW;IACjC,UAAU,QAAQ,GAAG,CAAC,OAAO;IAC7B,MAAM,QAAQ,GAAG,CAAC,OAAO;IACzB,oBAAoB;IACpB,iBAAiB;IACjB,YAAY;IACZ,iBAAiB;IACjB,uBAAuB;AAGzB;AAEA,2BAA2B;AAC3B,qEAAqE;AACrE,2DAA2D;AAC3D,IAAI;AAEJ,iCAAiC;AACjC,gDAAgD;AAChD;;KAGO;IACL,oDAAoD;IACpD,4FAA4F;IAC5F,IAAI,CAAC,yDAAO,SAAS,EAAE;QACrB,yDAAO,SAAS,GAAG,8IAAK,CAAC,UAAU,CAAC;IACtC;IACA,OAAO,yDAAO,SAAS;AACzB;uCAEe"}},
    {"offset": {"line": 157, "column": 0}, "map": {"version":3,"sources":["file:///D:/erp_project/src/app/api/purchasing/po/%5Bid%5D/route.js"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport pool from '../../../../lib/db'; \r\n\r\nexport async function GET(request, { params }) {\r\n  try {\r\n    const { id } = await params; \r\n\r\n    // -------------------------------------------------------------------\r\n    // ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏î‡∏∂‡∏á‡∏´‡∏±‡∏ß‡∏ö‡∏¥‡∏• (PO Header) + ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î Supplier\r\n    // -------------------------------------------------------------------\r\n    const sqlPO = `\r\n      SELECT \r\n        po.*, \r\n        s.name as supplier_name, \r\n        s.phone as supplier_phone, \r\n        s.email as supplier_email,\r\n        s.contact_name as contact_person,\r\n        s.tax_id as supplier_tax_id,\r\n        s.branch as supplier_branch, \r\n        s.fax as supplier_fax,      \r\n        s.address as s_addr,\r\n        s.sub_district as s_sub_district,\r\n        s.district as s_district,\r\n        s.province as s_province,\r\n        s.zipcode as s_zipcode\r\n      FROM purchase_orders po\r\n      LEFT JOIN suppliers s ON po.supplier_id = s.id\r\n      WHERE po.id = ?\r\n    `;\r\n    const [poRows] = await pool.query(sqlPO, [id]);\r\n\r\n    if (poRows.length === 0) return NextResponse.json({ error: '‡πÑ‡∏°‡πà‡∏û‡∏ö PO' }, { status: 404 });\r\n    \r\n    const poData = poRows[0];\r\n\r\n    // ‡∏™‡∏£‡πâ‡∏≤‡∏á \"‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏ï‡πá‡∏°\"\r\n    const fullAddress = [\r\n        poData.s_addr, \r\n        (poData.s_sub_district ? `‡∏ï.${poData.s_sub_district}` : null),\r\n        (poData.s_district ? `‡∏≠.${poData.s_district}` : null),\r\n        (poData.s_province ? `‡∏à.${poData.s_province}` : null),\r\n        poData.s_zipcode\r\n    ].filter(Boolean).join(' ');\r\n\r\n    poData.supplier_full_address = fullAddress || poData.s_addr || '-'; \r\n\r\n    // -------------------------------------------------------------------\r\n    // ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Items)\r\n    // -------------------------------------------------------------------\r\n    const sqlItems = `\r\n        SELECT \r\n            poi.*, \r\n            -- ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏±‡∏á‡∏Å‡πà‡∏≠‡∏ô ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏≤ custom_item_name ‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå\r\n            COALESCE(p.name, poi.custom_item_name, '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠)') as product_name,\r\n            COALESCE(p.product_code, '-') as product_code, \r\n            COALESCE(p.unit, '‡∏ä‡∏¥‡πâ‡∏ô') as unit\r\n        FROM purchase_order_items poi\r\n        LEFT JOIN products p ON poi.product_id = p.id\r\n        WHERE poi.po_id = ?\r\n    `;\r\n    const [items] = await pool.query(sqlItems, [id]);\r\n\r\n    return NextResponse.json({ \r\n        ...poData, \r\n        items: items \r\n    });\r\n\r\n  } catch (error) {\r\n    console.error(\"üî• API ERROR:\", error);\r\n    return NextResponse.json({ error: error.message }, { status: 500 });\r\n  }\r\n}\r\n\r\nexport async function PUT(request, { params }) {\r\n    let connection;\r\n    try {\r\n        const { id } = await params;\r\n        const body = await request.json();\r\n        \r\n        const { supplier_id, order_date, expected_date, items, total_amount, remarks, shipping_address } = body;\r\n\r\n        connection = await pool.getConnection();\r\n        await connection.beginTransaction();\r\n\r\n        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏±‡∏ß‡∏ö‡∏¥‡∏• PO\r\n        const updateHeaderSql = `\r\n            UPDATE purchase_orders \r\n            SET supplier_id = ?, order_date = ?, expected_date = ?, total_amount = ?, remarks = ?, shipping_address = ?\r\n            WHERE id = ?\r\n        `;\r\n        await connection.query(updateHeaderSql, [\r\n            supplier_id, \r\n            order_date, \r\n            expected_date, \r\n            total_amount, \r\n            remarks || null, \r\n            shipping_address || '‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏ç‡πà (HQ)', \r\n            id\r\n        ]);\r\n\r\n        // ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î\r\n        await connection.query(`DELETE FROM purchase_order_items WHERE po_id = ?`, [id]);\r\n\r\n        // ‚úÖ Insert ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ä‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö custom_item_name)\r\n        for (const item of items) {\r\n            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏±‡∏á (‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á) ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á product_id ‡πÄ‡∏õ‡πá‡∏ô null\r\n            const pId = item.product_id || null;\r\n            // ‡∏î‡∏±‡∏Å‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á key: custom_item_name ‡πÅ‡∏•‡∏∞ custom_name)\r\n            const customName = item.custom_item_name || item.custom_name || null;\r\n\r\n            await connection.query(\r\n                `INSERT INTO purchase_order_items (po_id, product_id, custom_item_name, quantity, unit_price, total_price) \r\n                 VALUES (?, ?, ?, ?, ?, ?)`,\r\n                [id, pId, customName, item.qty, item.price, (item.qty * item.price)]\r\n            );\r\n        }\r\n\r\n        await connection.commit();\r\n        return NextResponse.json({ success: true, message: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' });\r\n\r\n    } catch (error) {\r\n        if (connection) await connection.rollback();\r\n        console.error(\"Update PO Error:\", error);\r\n        return NextResponse.json({ error: error.message }, { status: 500 });\r\n    } finally {\r\n        if (connection) connection.release();\r\n    }\r\n}"],"names":[],"mappings":"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"}}]
}