{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/erp_project/src/app/api/purchasing/pr/route.js"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport pool from '../../lib/db';\r\n\r\n// üü¢ GET: ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î\r\nexport async function GET() {\r\n    try {\r\n        // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ PR ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ö‡∏¥‡∏•‡∏ô‡∏±‡πâ‡∏ô‡πÜ\r\n        const sql = `\r\n            SELECT \r\n                pr.*,\r\n                (SELECT COUNT(*) FROM purchase_request_items WHERE pr_id = pr.id) as item_count\r\n            FROM purchase_requests pr\r\n            ORDER BY pr.created_at DESC\r\n        `;\r\n        const [rows] = await pool.query(sql);\r\n        return NextResponse.json(rows);\r\n    } catch (error) {\r\n        console.error(\"Fetch PR Error:\", error);\r\n        return NextResponse.json({ error: error.message }, { status: 500 });\r\n    }\r\n}\r\n\r\n// üîµ POST: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏Ñ‡∏≤)\r\nexport async function POST(request) {\r\n    let connection;\r\n    try {\r\n        const body = await request.json();\r\n        const { request_date, remarks, items, user_id } = body;\r\n\r\n        // 1. ‡πÄ‡∏à‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ PR-yyyyMM-xxxx\r\n        const datePart = new Date(request_date).toISOString().slice(0, 7).replace('-', '');\r\n        const [lastPr] = await pool.query(`SELECT pr_number FROM purchase_requests WHERE pr_number LIKE 'PR-${datePart}-%' ORDER BY id DESC LIMIT 1`);\r\n        \r\n        let runNumber = 1;\r\n        if (lastPr.length > 0) {\r\n            const lastRun = parseInt(lastPr[0].pr_number.split('-')[2]);\r\n            runNumber = lastRun + 1;\r\n        }\r\n        const prNumber = `PR-${datePart}-${String(runNumber).padStart(4, '0')}`;\r\n\r\n        connection = await pool.getConnection();\r\n        await connection.beginTransaction();\r\n\r\n        // 2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏±‡∏ß‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£\r\n        const [resHeader] = await connection.query(\r\n            `INSERT INTO purchase_requests (pr_number, request_date, requester_id, remarks, status) \r\n             VALUES (?, ?, ?, ?, 'Pending')`,\r\n            [prNumber, request_date, user_id || 1, remarks || null]\r\n        );\r\n        const prId = resHeader.insertId;\r\n\r\n        // 3. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏Ñ‡πà ID ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÅ‡∏•‡∏∞ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)\r\n        for (const item of items) {\r\n            await connection.query(\r\n                `INSERT INTO purchase_request_items (pr_id, product_id, quantity) \r\n                 VALUES (?, ?, ?)`,\r\n                [prId, item.product_id, item.qty]\r\n            );\r\n        }\r\n\r\n        await connection.commit();\r\n        return NextResponse.json({ success: true, prNumber, message: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡∏Ç‡∏≠‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' });\r\n\r\n    } catch (error) {\r\n        if (connection) await connection.rollback();\r\n        console.error(\"Create PR Error:\", error);\r\n        return NextResponse.json({ error: error.message }, { status: 500 });\r\n    } finally {\r\n        if (connection) connection.release();\r\n    }\r\n}"],"names":[],"mappings":";;;;;;AAAA;;;;;;;;AAIO,eAAe;IAClB,IAAI;QACA,mDAAmD;QACnD,MAAM,MAAM,CAAC;;;;;;QAMb,CAAC;QACD,MAAM,CAAC,KAAK,GAAG,MAAM,KAAK,KAAK,CAAC;QAChC,OAAO,gJAAY,CAAC,IAAI,CAAC;IAC7B,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,mBAAmB;QACjC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO,MAAM,OAAO;QAAC,GAAG;YAAE,QAAQ;QAAI;IACrE;AACJ;AAGO,eAAe,KAAK,OAAO;IAC9B,IAAI;IACJ,IAAI;QACA,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,YAAY,EAAE,OAAO,EAAE,KAAK,EAAE,OAAO,EAAE,GAAG;QAElD,oCAAoC;QACpC,MAAM,WAAW,IAAI,KAAK,cAAc,WAAW,GAAG,KAAK,CAAC,GAAG,GAAG,OAAO,CAAC,KAAK;QAC/E,MAAM,CAAC,OAAO,GAAG,MAAM,KAAK,KAAK,CAAC,CAAC,iEAAiE,EAAE,SAAS,4BAA4B,CAAC;QAE5I,IAAI,YAAY;QAChB,IAAI,OAAO,MAAM,GAAG,GAAG;YACnB,MAAM,UAAU,SAAS,MAAM,CAAC,EAAE,CAAC,SAAS,CAAC,KAAK,CAAC,IAAI,CAAC,EAAE;YAC1D,YAAY,UAAU;QAC1B;QACA,MAAM,WAAW,CAAC,GAAG,EAAE,SAAS,CAAC,EAAE,OAAO,WAAW,QAAQ,CAAC,GAAG,MAAM;QAEvE,aAAa,MAAM,KAAK,aAAa;QACrC,MAAM,WAAW,gBAAgB;QAEjC,qBAAqB;QACrB,MAAM,CAAC,UAAU,GAAG,MAAM,WAAW,KAAK,CACtC,CAAC;2CAC8B,CAAC,EAChC;YAAC;YAAU;YAAc,WAAW;YAAG,WAAW;SAAK;QAE3D,MAAM,OAAO,UAAU,QAAQ;QAE/B,wDAAwD;QACxD,KAAK,MAAM,QAAQ,MAAO;YACtB,MAAM,WAAW,KAAK,CAClB,CAAC;iCACgB,CAAC,EAClB;gBAAC;gBAAM,KAAK,UAAU;gBAAE,KAAK,GAAG;aAAC;QAEzC;QAEA,MAAM,WAAW,MAAM;QACvB,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAM;YAAU,SAAS;QAAuB;IAExF,EAAE,OAAO,OAAO;QACZ,IAAI,YAAY,MAAM,WAAW,QAAQ;QACzC,QAAQ,KAAK,CAAC,oBAAoB;QAClC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO,MAAM,OAAO;QAAC,GAAG;YAAE,QAAQ;QAAI;IACrE,SAAU;QACN,IAAI,YAAY,WAAW,OAAO;IACtC;AACJ"}}]
}