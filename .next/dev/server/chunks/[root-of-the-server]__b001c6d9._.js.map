{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"sources":["file:///D:/erp_project/src/app/api/accounting/invoices/route.js"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport mysql from 'mysql2/promise';\r\n\r\n// Config ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•\r\nconst dbConfig = {\r\n    host: process.env.DB_HOST || '127.0.0.1',\r\n    user: process.env.DB_USER || 'root',\r\n    password: process.env.DB_PASSWORD || '',\r\n    database: process.env.DB_NAME || 'erp_project',\r\n    port: process.env.DB_PORT ? parseInt(process.env.DB_PORT) : 3306,\r\n    connectTimeout: 10000\r\n};\r\n\r\n// üü¢ 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (GET)\r\nexport async function GET(request) {\r\n    let connection;\r\n    try {\r\n        connection = await mysql.createConnection(dbConfig);\r\n        const [rows] = await connection.execute(`\r\n            SELECT invoices.*, projects.project_name \r\n            FROM invoices \r\n            LEFT JOIN projects ON invoices.project_id = projects.id \r\n            ORDER BY invoices.id DESC\r\n        `);\r\n        await connection.end();\r\n        return NextResponse.json({ invoices: rows });\r\n    } catch (error) {\r\n        console.error(\"GET INVOICES ERROR:\", error);\r\n        return NextResponse.json({ error: error.message }, { status: 500 });\r\n    }\r\n}\r\n\r\n// üîµ 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà (POST) - ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Logic ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏ö‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå\r\n// üîµ 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà (POST)\r\nexport async function POST(req) {\r\n    let connection;\r\n    try {\r\n        const body = await req.json();\r\n        const { \r\n            project_id, \r\n            customer_name, \r\n            customer_address, \r\n            customer_tax_id, \r\n            items, \r\n            due_date,\r\n            doc_date,\r\n            // ‚úÖ ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏†‡∏≤‡∏©‡∏µ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏ô\r\n            subtotal,\r\n            vat_rate,\r\n            vat_amount,\r\n            grand_total,\r\n            wht_rate,\r\n            wht_amount\r\n        } = body;\r\n\r\n        connection = await mysql.createConnection(dbConfig);\r\n        await connection.beginTransaction();\r\n\r\n        const dateObj = new Date();\r\n        const year = dateObj.getFullYear();\r\n        const month = String(dateObj.getMonth() + 1).padStart(2, '0');\r\n        const prefix = `INV-${year}${month}-`;\r\n\r\n        const [lastInvoice] = await connection.execute(\r\n            `SELECT doc_number FROM invoices WHERE doc_number LIKE ? ORDER BY id DESC LIMIT 1`,\r\n            [`${prefix}%`]\r\n        );\r\n\r\n        let newDocNumber = lastInvoice.length > 0 \r\n            ? `${prefix}${String(parseInt(lastInvoice[0].doc_number.split('-')[2]) + 1).padStart(3, '0')}`\r\n            : `${prefix}001`;\r\n\r\n        const projectQuantity = items.length > 0 ? items[0].quantity : 1;\r\n\r\n        // --- C. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏±‡∏ß‡∏ö‡∏¥‡∏• (invoices) ---\r\n        // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å vat_rate, wht_rate, wht_amount ‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á\r\n        const [result] = await connection.execute(\r\n            `INSERT INTO invoices \r\n            (project_id, doc_number, doc_date, due_date, customer_name, customer_address, customer_tax_id, quantity, subtotal, vat_rate, vat_amount, grand_total, wht_rate, wht_amount, status) \r\n            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'sent')`,\r\n            [\r\n                project_id || null, \r\n                newDocNumber, \r\n                doc_date, \r\n                due_date, \r\n                customer_name, \r\n                customer_address, \r\n                customer_tax_id, \r\n                projectQuantity, \r\n                subtotal, \r\n                vat_rate || 0,     // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏ó VAT\r\n                vat_amount, \r\n                grand_total,\r\n                wht_rate || 0,     // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏ó WHT\r\n                wht_amount || 0    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î WHT\r\n            ]\r\n        );\r\n\r\n        const invoiceId = result.insertId;\r\n\r\n        // --- D. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (invoice_items) ---\r\n        for (const item of items) {\r\n            await connection.execute(\r\n                `INSERT INTO invoice_items (invoice_id, description, quantity, unit_price, total) \r\n                 VALUES (?, ?, ?, ?, ?)`,\r\n                [invoiceId, item.description, item.quantity, item.unit_price, (item.quantity * item.unit_price)]\r\n            );\r\n        }\r\n\r\n        await connection.commit();\r\n        await connection.end();\r\n\r\n        return NextResponse.json({ success: true, doc_number: newDocNumber });\r\n\r\n    } catch (error) {\r\n        if (connection) await connection.rollback();\r\n        console.error(\"CREATE INVOICE ERROR:\", error);\r\n        return NextResponse.json({ error: error.message }, { status: 500 });\r\n    }\r\n}"],"names":[],"mappings":"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"}}]
}