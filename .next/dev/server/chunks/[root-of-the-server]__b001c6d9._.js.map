{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"sources":["file:///D:/erp_project/src/app/api/accounting/invoices/route.js"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport mysql from 'mysql2/promise';\r\n\r\n// Config ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•\r\nconst dbConfig = {\r\n    host: process.env.DB_HOST || '127.0.0.1',\r\n    user: process.env.DB_USER || 'root',\r\n    password: process.env.DB_PASSWORD || '',\r\n    database: process.env.DB_NAME || 'erp_project',\r\n    port: process.env.DB_PORT ? parseInt(process.env.DB_PORT) : 3306,\r\n    connectTimeout: 10000\r\n};\r\n\r\n// üü¢ 1. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (GET) - ‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡πÇ‡∏ä‡∏ß‡πå‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\r\nexport async function GET(request) {\r\n    let connection;\r\n    try {\r\n        connection = await mysql.createConnection(dbConfig);\r\n        \r\n        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• invoices ‡πÅ‡∏•‡∏∞ join ‡∏Å‡∏±‡∏ö projects ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)\r\n        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏™‡∏∏‡∏î‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î\r\n        const [rows] = await connection.execute(`\r\n            SELECT invoices.*, projects.project_name \r\n            FROM invoices \r\n            LEFT JOIN projects ON invoices.project_id = projects.id \r\n            ORDER BY invoices.id DESC\r\n        `);\r\n\r\n        await connection.end();\r\n        return NextResponse.json({ invoices: rows });\r\n    } catch (error) {\r\n        console.error(\"GET INVOICES ERROR:\", error);\r\n        return NextResponse.json({ error: error.message }, { status: 500 });\r\n    }\r\n}\r\n\r\n// üîµ 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà (POST) - ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á DB\r\nexport async function POST(req) {\r\n    let connection;\r\n    try {\r\n        const body = await req.json();\r\n        const { \r\n            project_id, \r\n            customer_name, \r\n            customer_address, \r\n            customer_tax_id, \r\n            items, // Array ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤\r\n            due_date,\r\n            doc_date \r\n        } = body;\r\n\r\n        connection = await mysql.createConnection(dbConfig);\r\n        await connection.beginTransaction(); // ‡πÄ‡∏£‡∏¥‡πà‡∏° Transaction (‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏ó‡∏∏‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏´‡∏°‡∏î)\r\n\r\n        // --- A. ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ô‡πÄ‡∏•‡∏Ç‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (INV-YYYYMM-XXX) ---\r\n        const dateObj = new Date();\r\n        const year = dateObj.getFullYear();\r\n        const month = String(dateObj.getMonth() + 1).padStart(2, '0');\r\n        const prefix = `INV-${year}${month}-`;\r\n\r\n        // ‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ\r\n        const [lastInvoice] = await connection.execute(\r\n            `SELECT doc_number FROM invoices WHERE doc_number LIKE ? ORDER BY id DESC LIMIT 1`,\r\n            [`${prefix}%`]\r\n        );\r\n\r\n        let newDocNumber;\r\n        if (lastInvoice.length > 0) {\r\n            const lastNo = lastInvoice[0].doc_number; \r\n            const runningNo = parseInt(lastNo.split('-')[2]) + 1; \r\n            newDocNumber = `${prefix}${String(runningNo).padStart(3, '0')}`;\r\n        } else {\r\n            newDocNumber = `${prefix}001`; // ‡πÉ‡∏ö‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô\r\n        }\r\n\r\n        // --- B. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô ---\r\n        let subtotal = 0;\r\n        items.forEach(item => {\r\n            subtotal += (parseFloat(item.quantity) * parseFloat(item.unit_price));\r\n        });\r\n        const vatRate = 7;\r\n        const vatAmount = subtotal * (vatRate / 100);\r\n        const grandTotal = subtotal + vatAmount;\r\n\r\n        // --- C. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏±‡∏ß‡∏ö‡∏¥‡∏• (invoices) ---\r\n        const [result] = await connection.execute(\r\n            `INSERT INTO invoices \r\n            (project_id, doc_number, doc_date, due_date, customer_name, customer_address, customer_tax_id, subtotal, vat_amount, grand_total, status) \r\n            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'sent')`,\r\n            [project_id || null, newDocNumber, doc_date, due_date, customer_name, customer_address, customer_tax_id, subtotal, vatAmount, grandTotal]\r\n        );\r\n\r\n        const invoiceId = result.insertId;\r\n\r\n        // --- D. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (invoice_items) ---\r\n        for (const item of items) {\r\n            await connection.execute(\r\n                `INSERT INTO invoice_items (invoice_id, description, quantity, unit_price, total) \r\n                 VALUES (?, ?, ?, ?, ?)`,\r\n                [invoiceId, item.description, item.quantity, item.unit_price, (item.quantity * item.unit_price)]\r\n            );\r\n        }\r\n\r\n        await connection.commit(); // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à\r\n        await connection.end();\r\n\r\n        return NextResponse.json({ success: true, doc_number: newDocNumber });\r\n\r\n    } catch (error) {\r\n        if (connection) await connection.rollback(); // ‚ùå ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏ñ‡πâ‡∏≤‡∏û‡∏±‡∏á\r\n        console.error(\"CREATE INVOICE ERROR:\", error);\r\n        return NextResponse.json({ error: error.message }, { status: 500 });\r\n    }\r\n}"],"names":[],"mappings":"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"}}]
}