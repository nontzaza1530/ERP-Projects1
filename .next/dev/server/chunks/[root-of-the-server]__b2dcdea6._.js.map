{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 127, "column": 0}, "map": {"version":3,"sources":["file:///D:/erp_project/src/lib/minio.js"],"sourcesContent":["import * as Minio from 'minio';\r\n\r\n// การตั้งค่าเชื่อมต่อ (ตามที่คุณเข้าหน้าเว็บ MinIO ได้)\r\nexport const minioClient = new Minio.Client({\r\n  endPoint: '192.168.1.76',      // ถ้าอยู่เครื่องเดียวกันใช้ localhost\r\n  port: 9000,                 // Port API ของ MinIO (ไม่ใช่ Console 9001 นะ)\r\n  useSSL: false, \r\n  accessKey: 'smartg',    // ⚠️ เช็ค User ที่คุณใช้ login\r\n  secretKey: 'StrongPass123!'     // ⚠️ เช็ค Password ที่คุณใช้ login\r\n});\r\n\r\nexport const BUCKET_NAME = 'erp'; // ชื่อ Bucket ตามรูปของคุณ"],"names":[],"mappings":";;;;;;AAAA;;AAGO,MAAM,cAAc,IAAI,0KAAY,CAAC;IAC1C,UAAU;IACV,MAAM;IACN,QAAQ;IACR,WAAW;IACX,WAAW,iBAAqB,mCAAmC;AACrE;AAEO,MAAM,cAAc,OAAO,2BAA2B"}},
    {"offset": {"line": 147, "column": 0}, "map": {"version":3,"sources":["file:///D:/erp_project/src/app/api/production/cost-upload/route.js"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport pool from '@/lib/minio';\r\n// ✅ แก้ 1: Import จากไฟล์ minio.js ที่คุณมีอยู่แล้ว\r\n// (ถ้าในไฟล์ minio.js คุณใช้ export default ให้เอาวงเล็บปีกกา {} ออกนะครับ)\r\nimport { minioClient } from '@/app/lib/minio'; \r\n\r\n// ✅ แก้ 2: ใช้ชื่อ Bucket ว่า 'erp' ตามที่คุณตั้ง\r\nconst BUCKET_NAME = 'erp'; \r\n\r\nexport async function POST(request) {\r\n  try {\r\n    const data = await request.formData();\r\n    \r\n    // 1. รับข้อมูล Form\r\n    const projectId = data.get('project_id');\r\n    const costType = data.get('cost_type');\r\n    const description = data.get('description');\r\n    const amount = data.get('amount');\r\n    const quantity = data.get('quantity');\r\n    const recordedBy = data.get('recorded_by');\r\n    const recordedDate = data.get('recorded_date');\r\n    \r\n    // 2. จัดการไฟล์รูป (Upload to MinIO)\r\n    const file = data.get('evidence_file');\r\n    let fileUrl = null;\r\n\r\n    if (file && file !== 'undefined') {\r\n      const bytes = await file.arrayBuffer();\r\n      const buffer = Buffer.from(bytes);\r\n\r\n      // ตั้งชื่อไฟล์: costs/ประเภท/เวลา-ชื่อไฟล์\r\n      const subFolder = costType || 'general';\r\n      const timestamp = Date.now();\r\n      const objectName = `costs/${subFolder}/${timestamp}-${file.name.replace(/\\s/g, '_')}`;\r\n      \r\n      // ส่งเข้า MinIO\r\n      await minioClient.putObject(BUCKET_NAME, objectName, buffer, file.size, {\r\n        'Content-Type': file.type\r\n      });\r\n\r\n      // สร้าง Link URL\r\n      const minioConfig = minioClient.transport; // ดึง config ที่คุณตั้งไว้ใน minio.js\r\n      const protocol = minioConfig.useSSL ? 'https' : 'http';\r\n      const host = minioConfig.endPoint;\r\n      const port = minioConfig.port ? `:${minioConfig.port}` : '';\r\n      \r\n      // URL ผลลัพธ์: http://localhost:9000/erp/costs/material/xxxx.jpg\r\n      fileUrl = `${protocol}://${host}${port}/${BUCKET_NAME}/${objectName}`;\r\n    }\r\n\r\n    // 3. บันทึกลง Database (ใช้ชื่อตาราง project_costs)\r\n    await pool.query(\r\n      `INSERT INTO project_costs \r\n      (project_id, cost_type, description, amount, quantity, recorded_by, recorded_date, evidence_path) \r\n      VALUES (?, ?, ?, ?, ?, ?, ?, ?)`,\r\n      [projectId, costType, description, amount, quantity, recordedBy, recordedDate, fileUrl]\r\n    );\r\n\r\n    return NextResponse.json({ success: true, url: fileUrl });\r\n\r\n  } catch (error) {\r\n    console.error('Upload Error:', error);\r\n    return NextResponse.json({ error: error.message }, { status: 500 });\r\n  }\r\n}"],"names":[],"mappings":";;;;AAAA;AACA;;;;;;;;;AAKA,kDAAkD;AAClD,MAAM,cAAc;AAEb,eAAe,KAAK,OAAO;IAChC,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,QAAQ;QAEnC,oBAAoB;QACpB,MAAM,YAAY,KAAK,GAAG,CAAC;QAC3B,MAAM,WAAW,KAAK,GAAG,CAAC;QAC1B,MAAM,cAAc,KAAK,GAAG,CAAC;QAC7B,MAAM,SAAS,KAAK,GAAG,CAAC;QACxB,MAAM,WAAW,KAAK,GAAG,CAAC;QAC1B,MAAM,aAAa,KAAK,GAAG,CAAC;QAC5B,MAAM,eAAe,KAAK,GAAG,CAAC;QAE9B,qCAAqC;QACrC,MAAM,OAAO,KAAK,GAAG,CAAC;QACtB,IAAI,UAAU;QAEd,IAAI,QAAQ,SAAS,aAAa;YAChC,MAAM,QAAQ,MAAM,KAAK,WAAW;YACpC,MAAM,SAAS,OAAO,IAAI,CAAC;YAE3B,2CAA2C;YAC3C,MAAM,YAAY,YAAY;YAC9B,MAAM,YAAY,KAAK,GAAG;YAC1B,MAAM,aAAa,CAAC,MAAM,EAAE,UAAU,CAAC,EAAE,UAAU,CAAC,EAAE,KAAK,IAAI,CAAC,OAAO,CAAC,OAAO,MAAM;YAErF,gBAAgB;YAChB,MAAM,YAAY,SAAS,CAAC,aAAa,YAAY,QAAQ,KAAK,IAAI,EAAE;gBACtE,gBAAgB,KAAK,IAAI;YAC3B;YAEA,iBAAiB;YACjB,MAAM,cAAc,YAAY,SAAS,EAAE,sCAAsC;YACjF,MAAM,WAAW,YAAY,MAAM,GAAG,UAAU;YAChD,MAAM,OAAO,YAAY,QAAQ;YACjC,MAAM,OAAO,YAAY,IAAI,GAAG,CAAC,CAAC,EAAE,YAAY,IAAI,EAAE,GAAG;YAEzD,iEAAiE;YACjE,UAAU,GAAG,SAAS,GAAG,EAAE,OAAO,KAAK,CAAC,EAAE,YAAY,CAAC,EAAE,YAAY;QACvE;QAEA,oDAAoD;QACpD,MAAM,gIAAI,CAAC,KAAK,CACd,CAAC;;qCAE8B,CAAC,EAChC;YAAC;YAAW;YAAU;YAAa;YAAQ;YAAU;YAAY;YAAc;SAAQ;QAGzF,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAM,KAAK;QAAQ;IAEzD,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,iBAAiB;QAC/B,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO,MAAM,OAAO;QAAC,GAAG;YAAE,QAAQ;QAAI;IACnE;AACF"}}]
}