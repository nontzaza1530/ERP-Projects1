{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/erp_project/src/app/api/accounting/project-quotations/%5Bid%5D/route.js"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport pool from '@lib/db'; \r\n\r\nexport const dynamic = 'force-dynamic';\r\n\r\n// üü¢ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ 1 ‡πÉ‡∏ö (‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Edit ‡πÅ‡∏•‡∏∞ Print)\r\nexport async function GET(request, { params }) {\r\n    try {\r\n        const { id } = params;\r\n\r\n        // ‡∏î‡∏∂‡∏á‡∏´‡∏±‡∏ß‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£\r\n        const [headers] = await pool.query(`SELECT * FROM project_quotations WHERE id = ?`, [id]);\r\n        if (headers.length === 0) return NextResponse.json({ error: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£' }, { status: 404 });\r\n\r\n        // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô\r\n        const [items] = await pool.query(`SELECT * FROM project_quotation_items WHERE project_quotation_id = ?`, [id]);\r\n\r\n        return NextResponse.json({ ...headers[0], items });\r\n    } catch (error) {\r\n        return NextResponse.json({ error: error.message }, { status: 500 });\r\n    }\r\n}\r\n\r\n// üîµ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)\r\nexport async function PUT(request, { params }) {\r\n    let connection;\r\n    try {\r\n        const { id } = params;\r\n        const body = await request.json();\r\n        const { \r\n            quotation_type, customer_name, customer_address, contact_person, phone, \r\n            project_name, issue_date, valid_until, billing_date, total_amount, remarks, items \r\n        } = body;\r\n\r\n        connection = await pool.getConnection();\r\n        await connection.beginTransaction();\r\n\r\n        // 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß\r\n        await connection.query(\r\n            `UPDATE project_quotations \r\n             SET quotation_type=?, customer_name=?, customer_address=?, contact_person=?, phone=?, \r\n                 project_name=?, issue_date=?, valid_until=?, billing_date=?, total_amount=?, remarks=?\r\n             WHERE id=?`,\r\n            [quotation_type, customer_name, customer_address, contact_person, phone, project_name, issue_date, valid_until, billing_date || null, total_amount, remarks, id]\r\n        );\r\n\r\n        // 2. ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏¥‡πâ‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô)\r\n        await connection.query(`DELETE FROM project_quotation_items WHERE project_quotation_id = ?`, [id]);\r\n\r\n        // 3. Insert ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ\r\n        for (const item of items) {\r\n            await connection.query(\r\n                `INSERT INTO project_quotation_items (project_quotation_id, description, quantity, unit, unit_price, total_price) \r\n                 VALUES (?, ?, ?, ?, ?, ?)`,\r\n                [id, item.description, item.qty || item.quantity, item.unit, item.price || item.unit_price, ((item.qty || item.quantity) * (item.price || item.unit_price))]\r\n            );\r\n        }\r\n\r\n        await connection.commit();\r\n        return NextResponse.json({ success: true, message: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' });\r\n\r\n    } catch (error) {\r\n        if (connection) await connection.rollback();\r\n        return NextResponse.json({ error: error.message }, { status: 500 });\r\n    } finally {\r\n        if (connection) connection.release();\r\n    }\r\n}"],"names":[],"mappings":";;;;;;;;AAAA;;;;;;;;AAGO,MAAM,UAAU;AAGhB,eAAe,IAAI,OAAO,EAAE,EAAE,MAAM,EAAE;IACzC,IAAI;QACA,MAAM,EAAE,EAAE,EAAE,GAAG;QAEf,eAAe;QACf,MAAM,CAAC,QAAQ,GAAG,MAAM,KAAK,KAAK,CAAC,CAAC,6CAA6C,CAAC,EAAE;YAAC;SAAG;QACxF,IAAI,QAAQ,MAAM,KAAK,GAAG,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAc,GAAG;YAAE,QAAQ;QAAI;QAE3F,eAAe;QACf,MAAM,CAAC,MAAM,GAAG,MAAM,KAAK,KAAK,CAAC,CAAC,oEAAoE,CAAC,EAAE;YAAC;SAAG;QAE7G,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,GAAG,OAAO,CAAC,EAAE;YAAE;QAAM;IACpD,EAAE,OAAO,OAAO;QACZ,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO,MAAM,OAAO;QAAC,GAAG;YAAE,QAAQ;QAAI;IACrE;AACJ;AAGO,eAAe,IAAI,OAAO,EAAE,EAAE,MAAM,EAAE;IACzC,IAAI;IACJ,IAAI;QACA,MAAM,EAAE,EAAE,EAAE,GAAG;QACf,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EACF,cAAc,EAAE,aAAa,EAAE,gBAAgB,EAAE,cAAc,EAAE,KAAK,EACtE,YAAY,EAAE,UAAU,EAAE,WAAW,EAAE,YAAY,EAAE,YAAY,EAAE,OAAO,EAAE,KAAK,EACpF,GAAG;QAEJ,aAAa,MAAM,KAAK,aAAa;QACrC,MAAM,WAAW,gBAAgB;QAEjC,yBAAyB;QACzB,MAAM,WAAW,KAAK,CAClB,CAAC;;;uBAGU,CAAC,EACZ;YAAC;YAAgB;YAAe;YAAkB;YAAgB;YAAO;YAAc;YAAY;YAAa,gBAAgB;YAAM;YAAc;YAAS;SAAG;QAGpK,uDAAuD;QACvD,MAAM,WAAW,KAAK,CAAC,CAAC,kEAAkE,CAAC,EAAE;YAAC;SAAG;QAEjG,wCAAwC;QACxC,KAAK,MAAM,QAAQ,MAAO;YACtB,MAAM,WAAW,KAAK,CAClB,CAAC;0CACyB,CAAC,EAC3B;gBAAC;gBAAI,KAAK,WAAW;gBAAE,KAAK,GAAG,IAAI,KAAK,QAAQ;gBAAE,KAAK,IAAI;gBAAE,KAAK,KAAK,IAAI,KAAK,UAAU;gBAAG,CAAC,KAAK,GAAG,IAAI,KAAK,QAAQ,IAAI,CAAC,KAAK,KAAK,IAAI,KAAK,UAAU;aAAG;QAEpK;QAEA,MAAM,WAAW,MAAM;QACvB,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAM,SAAS;QAAqB;IAE5E,EAAE,OAAO,OAAO;QACZ,IAAI,YAAY,MAAM,WAAW,QAAQ;QACzC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO,MAAM,OAAO;QAAC,GAAG;YAAE,QAAQ;QAAI;IACrE,SAAU;QACN,IAAI,YAAY,WAAW,OAAO;IACtC;AACJ"}}]
}